version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Write environment variables to .env.production
        - env >> .env.production
        # Install pnpm globally (fastest method)
        - npm install -g pnpm@9 --force
        # Configure pnpm for speed
        - pnpm config set store-dir /root/.pnpm-store
        - pnpm config set package-import-method copy
        # CRITICAL: Only install production dependencies (skip devDependencies)
        - pnpm install --prod --frozen-lockfile --prefer-offline
    build:
      commands:
        # Build with standalone output (configured in next.config.ts)
        - pnpm run build
  artifacts:
    # Use standalone output directory (much smaller!)
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      # Cache Next.js build cache (most important!)
      - .next/cache/**/*
      # Cache pnpm global store
      - /root/.pnpm-store/**/*
      # Cache node_modules (for faster future builds)
      - node_modules/**/*
